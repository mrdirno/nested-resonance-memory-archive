#!/usr/bin/env python3
"""
C178: REM Hypothesis Test - Transcendental Basis vs. Lower Boundary
=====================================================================

Purpose: Test a hypothesis generated by REM exploration in NRM V2,
which suggested a link between transcendental basis and lower boundary dynamics.

Hypothesis: Removing the 'pi' oscillator from the transcendental basis will
shift the lower boundary for population collapse.

Experimental Design:
- Control Group: Full transcendental basis (pi, e, phi)
- Experimental Group: Modified basis (e, phi only)
- Frequency: 1.5% (known to be near the lower boundary)
- Seeds: 10 per group
- Total: 20 experiments
- Metric: Final agent population and collapse rate
"""

import sys
import json
from pathlib import Path
from typing import List, Dict, Any

# Add modules to path
sys.path.insert(0, str(Path(__file__).parent.parent / "fractal"))
sys.path.insert(0, str(Path(__file__).parent.parent / "bridge"))
sys.path.insert(0, str(Path(__file__).parent.parent))

from fractal_swarm import FractalSwarm
from core import constants

def run_experiment(
    basis: List[str],
    frequency: float,
    seeds: range,
    max_cycles: int = 3000
) -> List[Dict[str, Any]]:
    """
    Run a single experimental condition.
    """
    results = []
    for seed in seeds:
        print(f"  Running seed {seed} with basis {basis} and frequency {frequency*100:.2f}%...")
        
        # Initialize swarm with modified bridge
        swarm = FractalSwarm(
            workspace_path="/Volumes/dual/DUALITY-ZERO-V2/workspace",
            max_agents=50,
            clear_on_init=True
        )
        
        # Modify the transcendental basis in the bridge
        swarm.bridge.TRANS_C = basis

        # Spawn initial agents
        reality = {'cpu_percent': 10.0, 'memory_percent': 50.0}
        for _ in range(10):
            swarm.spawn_agent(reality)

        # Run simulation
        for cycle in range(max_cycles):
            swarm.evolve_cycle(delta_time=1.0)
            
            # Use the spawn frequency to control agent creation
            if cycle % int(1.0 / frequency) == 0:
                 swarm.spawn_agent(reality)
        
        # Get final stats
        stats = swarm.get_statistics()
        final_pop = stats['active_agents']
        
        results.append({
            'seed': seed,
            'basis': basis,
            'frequency': frequency,
            'final_population': final_pop,
            'collapsed': final_pop == 0
        })
    return results

def main():
    """Run the full experiment."""
    print("=" * 80)
    print("C178: REM Hypothesis Test - Transcendental Basis vs. Lower Boundary")
    print("=" * 80)

    # Experimental parameters
    frequency = 0.015  # 1.5%
    seeds = range(10)
    
    # Run Control Group
    print("\n[1] Running Control Group (Full Basis: pi, e, phi)...")
    control_results = run_experiment(['pi', 'e', 'phi'], frequency, seeds)

    # Run Experimental Group
    print("\n[2] Running Experimental Group (Modified Basis: e, phi)...")
    experimental_results = run_experiment(['e', 'phi'], frequency, seeds)

    # Save results
    all_results = control_results + experimental_results
    results_path = Path(__file__).parent / "results" / "c178_rem_hypothesis_test_results.json"
    results_path.parent.mkdir(parents=True, exist_ok=True)
    
    with open(results_path, 'w') as f:
        json.dump(all_results, f, indent=2)

    print(f"\n[3] Experiment complete. Results saved to {results_path}")
    
    # Preliminary analysis
    control_collapse_rate = sum(r['collapsed'] for r in control_results) / len(control_results)
    exp_collapse_rate = sum(r['collapsed'] for r in experimental_results) / len(experimental_results)
    
    print("\n--- Preliminary Results ---")
    print(f"Control Group Collapse Rate: {control_collapse_rate:.0%}")
    print(f"Experimental Group Collapse Rate: {exp_collapse_rate:.0%}")
    
    if control_collapse_rate != exp_collapse_rate:
        print("\n✅ PRELIMINARY FINDING: The transcendental basis appears to affect the collapse rate.")
        print("   This supports the REM-generated hypothesis of a link between c176_h3 and c177_h1.")
    else:
        print("\n⚠️ PRELIMINARY FINDING: No significant difference in collapse rate observed.")
        print("   This may falsify the REM-generated hypothesis.")


if __name__ == '__main__':
    main()
